<script>

// START HERE ===========================

//global variables

  var subjectIDs = [129750,129756,129761,129759,129758,129753,129754,129752,119567,129762,129750,129751,129760,33505,129757,129755];
  var subjectString = subjectIDs.toString();
  var subjectSlug = `&subject_ids=${subjectString}`;
  var subjectIDsAPI = `http://lgapi.libapps.com/1.1/guides/?site_id=103&key=83d416dc1ba38e91c12fee5de29a4527${subjectSlug}&expand=subjects&tag_names[]=Central%20Indiana%20Region&status[]=1&sort_by=name`;
  var stringIDs = subjectIDs.map(String);
  
// ===== lodash methods =====================
  
 
  
  $.getJSON(subjectIDsAPI, function(data) {

      // create empty array where objects {guide: xyz, subject: xyz} will go
    	var guideSubjectArray =[];
       
      // for each object in the JSON file
      data.forEach(function(guide) {
        
            // create empty object for pushing into array
          	  var nameSubjectObj = {};
          	  
          	  // create empty array for pushing subjects to
          	  var subjects = [];
              
          	  // set object key/values
              nameSubjectObj["name"] = guide.name;
          	  nameSubjectObj["subject"] = subjects;
          	  
          	  if (guide.friendly_url) {
        					 nameSubjectObj["url"] = guide.friendly_url;
        				} else {
        					 nameSubjectObj["url"] = guide.url;
                }
          	  
          	  // here's where it starts getting complicated
          	  
              // for every subject of each guide
          	   for (let item of guide.subjects) {
                  
                  // loop through subjects
            			for (let key in item) {
            			  
							      // create variable for ID string from JSON
							      var idNumber = item[key];
						          
						          // if that ID number is also in the subject ID array
						          // (this excludes any subjects that were assigned to the guide outside of these specific subjects)
      							  if ((_.includes(stringIDs, idNumber)) && key == "id" ) {
       								      
                  					subjects.push(item["name"]);
      							  }
      
                   }

                }
                     

              // take object full of name/subject key/value pairs and push it to the guide-subject array
              guideSubjectArray.push(nameSubjectObj);
              
      
      })
      
      // array where new name/subject/url objects (thisGuide) will be pushed
      var allSubjects = [];
		
    // for each guide in guideSubjectArray
       for (let guide of guideSubjectArray) {
        
          // and for each subject that the guide has
    			for (val in guide.subject) {
    
              // create an object with name/subject/url
              // and push it to the allSubjects array
              // which will later be sorted by subject and each subject counted
      		    var thisGuide = new Object();
                	thisGuide.name = guide.name;
                	thisGuide.subject = guide.subject[val];
          		   	thisGuide.url = guide.url;
          			  allSubjects.push(thisGuide);
        		}

        }
    
  
        // create arrays to 1) sort subjects alphabetically, and 2) hold guide count by subject
      	var sortedArray = _.orderBy(allSubjects, "subject", "asc");
      	var uniqueArray = _.countBy(sortedArray, "subject");
      	
      	// create counter for panel accordion collapse action
      	var panelCounter = 0;
      	
      	//create tile for each subject  (includes count of guides in subject)
      	//when tile clicked, reveal list of guides; when clicked again, list disappears (accordion panel style)
      	 var subjectList = `<div class="panel-group" id="accordion">`;
	 
      	//loop through subjects and count and create list items
      	_.forEach(uniqueArray, function(count, subject) {
      	   
            subjectList += `<div class="panel panel-default">
                              <div class="panel-heading">
                                <h5 class="panel-title">
                                  <a data-toggle="collapse" data-parent="#accordion" data-target="#collapse${panelCounter}" aria-expanded="false">
                                    ${subject}<span class="badge badge-default badge-pill">${count}</span>
                                  </a>
                                </h5>
                              </div>
                              <div id="collapse${panelCounter}" class="panel-collapse collapse">
                                <div class="panel-body">
                                <ul>`
                                  
                                  
                                   _.forEach(allSubjects, function(guide) {
                                      
                                      if (subject === guide.subject) {
                                        
                                        subjectList += `<li><a href="${guide.url}">${guide.name}</a></li>`;
                                      }
                                    
                                  })
                                  
                                  
            subjectList+=       `</ul>
                                </div>
                              </div>
                            </div>`
             
            panelCounter += 1;
        });
  
        subjectList += `</div>`;
        
      	
      	$('#published-guides').empty();
        $('#published-guides').append(subjectList);
    
  });


// 3.1) get rid of "central indiana" in guide titles
// 5) might want to do a "for...of" loop for iterating through subjects in each guide: https://stackoverflow.com/questions/11922383/access-process-nested-objects-arrays-or-json
/// 5a) IF it matches one of the subject IDs, then display
/// 5b) figure out how to access nested anonymous objects... for each loop?? i.e. for (const subject of data.subjects)

  
</script>